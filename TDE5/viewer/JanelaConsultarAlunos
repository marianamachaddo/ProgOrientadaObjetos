package viewer;

import java.util.ArrayList;
import javax.swing.JButton;
import javax.swing.JFrame;
import javax.swing.JPanel;
import javax.swing.JScrollPane;
import javax.swing.JTable;
import javax.swing.border.EmptyBorder;
import controller.aluno.CtrlManterAlunos;
import model.Aluno;

public class JanelaConsultarAlunos extends JanelaAbstrata<CtrlManterAlunos> {
    private JPanel contentPane;
    private JTable tabela;
    private ArrayList<Aluno> conjAlunos;
    private JScrollPane scrollPane;

    public JanelaConsultarAlunos(CtrlManterAlunos ctrl, ArrayList<Aluno> lista) {
        super(ctrl);
        setTitle("Manter Alunos");
        setDefaultCloseOperation(JFrame.DO_NOTHING_ON_CLOSE);
        setBounds(100, 100, 550, 320);
        contentPane = new JPanel();
        contentPane.setBorder(new EmptyBorder(5, 5, 5, 5));
        setContentPane(contentPane);
        contentPane.setLayout(null);

        JButton btSair = new JButton("Sair");
        btSair.addActionListener(e -> getCtrl().encerrar());
        btSair.setBounds(435, 247, 89, 23);
        contentPane.add(btSair);

        scrollPane = new JScrollPane();
        scrollPane.setBounds(10, 11, 514, 220);
        contentPane.add(scrollPane);
        
        atualizarDados(lista);

        JButton btIncluir = new JButton("Incluir");
        btIncluir.addActionListener(e -> getCtrl().iniciarIncluirAluno());
        btIncluir.setBounds(10, 247, 89, 23);
        contentPane.add(btIncluir);

        JButton btAlterar = new JButton("Alterar");
        btAlterar.addActionListener(e -> {
            Aluno aluno = obterLinhaSelecionada();
            if (aluno != null)
                getCtrl().iniciarAlterarAluno(aluno);
            else
                notificar("Selecione um aluno para alteração.");
        });
        btAlterar.setBounds(121, 247, 89, 23);
        contentPane.add(btAlterar);

        JButton btExcluir = new JButton("Excluir");
        btExcluir.addActionListener(e -> {
            Aluno aluno = obterLinhaSelecionada();
            if (aluno != null)
                getCtrl().iniciarExcluirAluno(aluno);
            else
                notificar("Selecione um aluno para exclusão.");
        });
        btExcluir.setBounds(231, 247, 89, 23);
        contentPane.add(btExcluir);
    }

    public void atualizarDados(ArrayList<Aluno> lista) {
        this.conjAlunos = lista;
        Aluno[] arrayAlunos = lista.toArray(new Aluno[0]);
        HelperTableModel h = new HelperTableModel(arrayAlunos);
        
        this.tabela = new JTable(h.getTableModel());
        new MeuHeaderListener(this.tabela); 
        
        this.scrollPane.setViewportView(this.tabela);
        
        this.scrollPane.revalidate();
        this.scrollPane.repaint();
    }

    public Aluno obterLinhaSelecionada() {
        int numLinha = this.tabela.getSelectedRow();
        if (numLinha != -1) {
            // CORREÇÃO: Pela ordem alfabética (Curso, Matricula, Nome), a Matrícula é a coluna 1.
            int matricula = Integer.parseInt(this.tabela.getValueAt(numLinha, 1).toString());
            
            for (Aluno a : conjAlunos) {
                if (a.getMatricula() == matricula) {
                    return a;
                }
            }
        }
        return null;
    }
}
